<!DOCTYPE html>
<html content="text/html; charset=utf-8">
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

<link type="text/css"  href="https://fonts.googleapis.com/css?family=Roboto:300,400,600" rel="stylesheet"> 


    <link rel="stylesheet" type="text/css" href="css/normalize.css">
  <!--<link rel="stylesheet" type="text/css" href="css/skeleton.css">-->
<link rel="stylesheet" type="text/css" href="css/app.css">

    <!-- Insert this line above script imports  -->
<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>

<!-- normal script imports etc  -->
     <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
  
    <script type="text/javascript" src="app/app.js"></script>
    <script type="text/javascript" src="app/parser_ledger.js"></script>
    <script type="text/javascript" src="app/FileSaver.js"></script>

    <!-- 1. Load libraries -->
    <script src="node_modules/x2js/x2js.js"></script>
     <!-- Polyfill(s) for older browsers -->
    <script src="node_modules/core-js/client/shim.min.js"></script>
    <script src="node_modules/zone.js/dist/zone.js"></script>
    <script src="node_modules/reflect-metadata/Reflect.js"></script>
    <script src="node_modules/systemjs/dist/system.src.js"></script>
    <!-- 2. Configure SystemJS -->
    <script src="systemjs.config.js"></script>
    <script>
      System.import('app').catch(function(err){ console.error(err); });
    </script>


<!-- Insert this line after script imports -->
<script>if (window.module) module = window.module;</script>

  </head>
  <body>

    <my-app>Loading...</my-app>
  </body>

  <script>
    
    var transactions = [];
        let engine;

        window.onload = function () {
            // Load the Visualization API and the corechart package.
            google.charts.load('current', { 'packages': ['corechart'] });

            var fileInput = $('#upload-ledger').get(0);

            fileInput.addEventListener('change', function () {

                var reader = new FileReader();

                reader.addEventListener('load', function () {
                    console.log("@" + reader.result + "@");

                    transactions = PARSER.parse(reader.result);

                    engine = new Engine(transactions);

                     $.each(engine.stats, function(index, value){
                        $("#infos").append('<li>' + value + '</li>')
                     }); 

                    var x = document.getElementById("fromAccount");
                    var y = document.getElementById("toAccount");
                    for(account of engine.allAccounts) {
                        accountName = account[0] + " / " + account[1].toFixed(2);

                        var option1 = document.createElement("option");
                        option1.text = accountName;
                        option1.value = account[0];
                        x.add(option1);

                        var option2 = document.createElement("option");
                        option2.text = accountName;
                        option2.value = account[0];
                        y.add(option2);
                    }

                    var ul = document.getElementById("transactions");

                    for(tr of engine.transactions){
                        var li = document.createElement("li");
                        li.appendChild(document.createTextNode(tr.header.title));

                        for(p of tr.postings){
                            li.appendChild(document.createElement("br"));
                            li.appendChild(document.createTextNode(p.account + " " + p.currency.amount + " " + p.comment));
                        }

                        ul.appendChild(li);
                    }
                });

                $('#filename').html(fileInput.value.replace(/.*[\/\\]/, ''));
                reader.readAsText(fileInput.files[0]);

            });

            
        }

        function loadTransactions() {
            var x = document.getElementById("fromAccount");
            var fromAccount = x.options[x.selectedIndex].value;

            var y = document.getElementById("toAccount");
            var toAccount = y.options[y.selectedIndex].value;

            eType = document.getElementById("type");
            type = eType.options[eType.selectedIndex].value;

            startDate = document.getElementById("startDate").value;
            endDate = document.getElementById("endDate").value;

            eGroupBy = document.getElementById("groupBy");
            groupBy = eGroupBy.options[eGroupBy.selectedIndex].value;
            
            eStatParam = document.getElementById("statParam");
            statParam = eStatParam.options[eStatParam.selectedIndex].value;

            ePeriodGap = document.getElementById("periodGap");
            periodGap = ePeriodGap.options[ePeriodGap.selectedIndex].value;
            
            numPeriods = document.getElementById("numPeriods").value;

            maxDepth = document.getElementById("maxDepth").value;

            engine.analyzeTransactions(
                fromAccount,
                toAccount,
                startDate,
                endDate,
                groupBy,
                statParam,
                periodGap,
                numPeriods,
                type,
                maxDepth);
        }
  </script>
</html>
