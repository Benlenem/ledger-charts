<!DOCTYPE html>
<html content="text/html; charset=utf-8">
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">


    <link rel="stylesheet" type="text/css" href="css/normalize.css">
  <link rel="stylesheet" type="text/css" href="css/skeleton.css">

    <!-- Insert this line above script imports  -->
<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>

<!-- normal script imports etc  -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
  
    <script type="text/javascript" src="src/app.js"></script>
    <script type="text/javascript" src="src/parser_ledger.js"></script>

<!-- Insert this line after script imports -->
<script>if (window.module) module = window.module;</script>


  </head>
  <body>

    <div class="container">
        <div class="row">
             <div class="twelve columns">
                <h4>Ledger charts</h4>
            </div>
        </div>

        <div class="row">
            <div class="eight columns">
                <p>Pour commencer veuillez sélectionner un fichier .ledger</p>
                <p id="nb_transactions"/>
            </div>

            <div class="four columns">
                <input id="file" type="file" />
            </div>
        </div>

        <div class="row">
            <div class="four columns">
               <select id="fromAccount">
                </select>
            </div>
            <div class="four columns">
                <select id="toAccount"></select>
            </div>
            <div class="four columns">
                <label><input type="text" id="maxDepth" value="1" />Profondeur</label>
            </div>
        </div>

        <div class="row">
            <div class="four columns">
                Type : <select id="type">
                    <option value="1">Débit</option>
                    <option value="2">Crédit</option>
                    <option value="3">Les deux</option>
                </select>
            </div>
            <div class="four columns">
                Date début: <input type="text" id="startDate" value="01/01/2012"/>
            </div>
            <div class="four columns">
                 Date fin: <input type="text" id="endDate" value="31/12/2016"/>
            </div>
        </div>

        <div class="row">
            <div class="six columns">
                Grouper par : <select id="groupBy">
                    <option value="1">Compte</option>
                    <option value="2">Année</option>
                    <option value="3">Semestre</option>
                    <option value="4">Trimestre</option>
                    <option value="5">Month</option>
                    <option value="6">Semaine</option>
                    <option value="7">Jour</option>
                </select>
            </div>
            <div class="six columns">
                 Calculer avec : <select id="statParam">
                    <option value="1">Somme</option>
                    <option value="2">Moyenne</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="six columns">
              Périodes : <select id="periodGap">
                    <option value="1">Aucune</option>
                    <option value="2">Année</option>
                                    <option value="3">Mois</option>
                                    <option value="4">Semaine</option>
                                    <option value="5">Jour</option>
                </select>
            </div>
            <div class="six columns">
                x de périodes: <input type="text" id="numPeriods" value="1" />
            </div>
        </div>

        <div class="row">
            <div class="twelve columns">
                 <input type="button" class="button-primary" value="Visualiser" onclick="javascript:loadTransactions();"/>
            </div>
        </div>

        <div class="row">
            <div class="twelve columns" id="chart_div"/>
        </div>

        <ul id="transactions">
        </ul>

    </div>
  </body>

  <script>
    
    var transactions = [];
        let engine;

        window.onload = function () {
            // Load the Visualization API and the corechart package.
            google.charts.load('current', { 'packages': ['corechart'] });

            var fileInput = document.querySelector('#file');

            fileInput.addEventListener('change', function () {

                var reader = new FileReader();

                reader.addEventListener('load', function () {
                    console.log("@" + reader.result + "@");

                    transactions = PARSER.parse(reader.result);

                    document.getElementById("nb_transactions").innerHTML = "Nb transactions : " + transactions.length;
                    
                    engine = new Engine(transactions);

                    var x = document.getElementById("fromAccount");
                    var y = document.getElementById("toAccount");
                    for(account of engine.getAllAccounts()) {
                        var option1 = document.createElement("option");
                        option1.text = account;
                        x.add(option1);

                        var option2 = document.createElement("option");
                        option2.text = account;
                        y.add(option2);
                    }

                    var ul = document.getElementById("transactions");

                    for(tr of engine.getAllTransactions()){
                        var li = document.createElement("li");
                        li.appendChild(document.createTextNode(tr.header.title));

                        for(p of tr.postings){
                            li.appendChild(document.createElement("br"));
                            li.appendChild(document.createTextNode(p.account + " " + p.currency.amount + " " + p.comment));
                        }

                        ul.appendChild(li);
                    }
                });

                reader.readAsText(fileInput.files[0]);

            });

            
        }

        function loadTransactions() {
            var x = document.getElementById("fromAccount");
            var fromAccount = x.options[x.selectedIndex].value;

            var y = document.getElementById("toAccount");
            var toAccount = y.options[y.selectedIndex].value;

            eType = document.getElementById("type");
            type = eType.options[eType.selectedIndex].value;

            startDate = document.getElementById("startDate").value;
            endDate = document.getElementById("endDate").value;

            eGroupBy = document.getElementById("groupBy");
            groupBy = eGroupBy.options[eGroupBy.selectedIndex].value;
            
            eStatParam = document.getElementById("statParam");
            statParam = eStatParam.options[eStatParam.selectedIndex].value;

            ePeriodGap = document.getElementById("periodGap");
            periodGap = ePeriodGap.options[ePeriodGap.selectedIndex].value;
            
            numPeriods = document.getElementById("numPeriods").value;

            maxDepth = document.getElementById("maxDepth").value;

            engine.analyzeTransactions(
                fromAccount,
                toAccount,
                startDate,
                endDate,
                groupBy,
                statParam,
                periodGap,
                numPeriods,
                type,
                maxDepth);
        }
  </script>
</html>
