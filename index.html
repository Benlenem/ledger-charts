<!DOCTYPE html>
<html content="text/html; charset=utf-8">
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
    <script type="text/javascript" src="http://requirejs.org/docs/release/2.3.1/minified/require.js"></script>
    <script type="text/javascript" src="src/app.js"></script>
    <script type="text/javascript" src="src/parser_ledger.js"></script>

  </head>
  <body>
    <input id="file" type="file" />
    <button onclick="javascript:loadTransactions();">Visualiser</button>
    <br/>
    <select multiple id="fromAccounts" style="height:150px;"></select>
    <br/>
    Type : <select id="type">
        <option value="1">Débit</option>
        <option value="2">Crédit</option>
        <option value="3">Les deux</option>
    </select>
    Date début: <input type="text" id="startDate" value="01/01/2012"/>
    Date fin: <input type="text" id="endDate" value="31/12/2016"/>
    Périodes : <select id="periodGap">
        <option value="1">Aucune</option>
        <option value="2">Année</option>
                           <option value="3">Mois</option>
                           <option value="4">Semaine</option>
                           <option value="5">Jour</option>
    </select>
    x de périodes: <input type="text" id="numPeriods" value="2" />
    Grouper par : <select id="groupBy">
        <option value="1">Compte</option>
        <option value="2">Année</option>
        <option value="3">Semestre</option>
        <option value="4">Trimestre</option>
        <option value="5">Month</option>
        <option value="6">Semaine</option>
        <option value="7">Jour</option>
    </select>
    Calculer avec : <select id="statParam">
        <option value="1">Somme</option>
        <option value="2">Moyenne</option>
    </select>

    <!--Div that will hold the pie chart-->
    <div id="chart_div"></div>
    <span id="nb_transactions"/>
    <br/>
  </body>

  <script>
    
    // You can also require other files to run in this process
    require('./renderer.js')
  
    var transactions = [];
        let engine;

        window.onload = function () {
            // Load the Visualization API and the corechart package.
            google.charts.load('current', { 'packages': ['corechart'] });

            var fileInput = document.querySelector('#file');

            fileInput.addEventListener('change', function () {

                var reader = new FileReader();

                reader.addEventListener('load', function () {
                    console.log("@" + reader.result + "@");

                    transactions = PARSER.parse(reader.result);

                    document.getElementById("nb_transactions").innerHTML = "Nb transactions : " + transactions.length;
                    
                    engine = new Engine(transactions);

                    var x = document.getElementById("fromAccounts");
                    for(account of engine.getAllAccounts()) {
                        var option = document.createElement("option");
                        option.text = account;
                        x.add(option);
                    }
                });

                reader.readAsText(fileInput.files[0]);

            });

            
        }

        function loadTransactions() {
            var x = document.getElementById("fromAccounts");
            var accounts = getSelectedValues(x);
            console.log(accounts);

            eType = document.getElementById("type");
            type = eType.options[eType.selectedIndex].value;

            startDate = document.getElementById("startDate").value;
            endDate = document.getElementById("endDate").value;

            eGroupBy = document.getElementById("groupBy");
            groupBy = eGroupBy.options[eGroupBy.selectedIndex].value;
            
            eStatParam = document.getElementById("statParam");
            statParam = eStatParam.options[eStatParam.selectedIndex].value;

            ePeriodGap = document.getElementById("periodGap");
            periodGap = ePeriodGap.options[ePeriodGap.selectedIndex].value;
            
            numPeriods = document.getElementById("numPeriods").value;

            engine.analyzeTransactions(
                accounts,
                startDate,
                endDate,
                groupBy,
                statParam,
                periodGap,
                numPeriods,
                type);
        }

        function getSelectedValues(select) {
            var result = [];
            var options = select && select.options;
            var opt;

            for (var i = 0, iLen = options.length; i < iLen; i++) {
                opt = options[i];

                if (opt.selected) {
                    result.push(opt.value || opt.text);
                }
            }
            return result;
        }
  </script>
</html>
